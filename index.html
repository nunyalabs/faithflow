<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FaithFlow Manager</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs (Compat for simple HTML usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-surface: rgba(255, 255, 255, 0.65);
            --glass-highlight: rgba(255, 255, 255, 0.8);
            
            /* Dynamic Theme Variables */
            --primary-color: #3b82f6;
            --secondary-color: #8b5cf6;
        }

        body { 
            font-family: 'SF Pro Display', 'Inter', sans-serif; 
            /* Dynamic Background based on theme */
            background: linear-gradient(135deg, var(--bg-start, #e0f2fe) 0%, var(--bg-end, #f3e8ff) 100%);
            background-attachment: fixed;
            -webkit-tap-highlight-color: transparent;
        }

        /* Liquid Glassy Effect */
        .glass-panel {
            background: var(--glass-surface);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.05);
            border-radius: 1.5rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .glass-card:active {
            transform: scale(0.98);
        }

        /* Sidebar Glass */
        .glass-sidebar {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border-right: 1px solid rgba(255, 255, 255, 0.3);
        }

        .sidebar-link.active {
            background: var(--primary-color);
            color: white;
            border-radius: 12px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .sidebar-link:hover:not(.active) {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
        }

        /* Blob Background Animation */
        .blob {
            position: absolute;
            filter: blur(80px);
            z-index: -1;
            opacity: 0.6;
            animation: float 10s infinite ease-in-out;
        }
        @keyframes float {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0px, 0px) scale(1); }
        }

        /* Presentation Mode */
        #presentation-layer {
            display: none;
            position: fixed;
            inset: 0;
            background: black;
            color: white;
            z-index: 9999;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
            flex-direction: column;
        }
        #presentation-text {
            font-size: clamp(2rem, 5vw, 5rem);
            font-weight: 800;
            line-height: 1.3;
            text-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-width: 90%;
        }
        #presentation-logo {
            max-height: 15vh;
            margin-bottom: 2vh;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.3));
        }

        /* Chat Bubbles */
        .chat-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            position: relative;
            animation: fadeIn 0.3s ease;
        }
        .chat-own {
            background: var(--primary-color);
            color: white;
            border-bottom-right-radius: 0.25rem;
            margin-left: auto;
        }
        .chat-other {
            background: white;
            color: #1e293b;
            border-bottom-left-radius: 0.25rem;
            margin-right: auto;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Utilities */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .text-theme-primary { color: var(--primary-color); }
        .bg-theme-primary { background-color: var(--primary-color); }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    borderRadius: {
                        '3xl': '1.5rem',
                        '2xl': '1rem',
                    }
                }
            }
        }
    </script>
</head>
<body class="h-screen flex overflow-hidden text-slate-800">

    <!-- Ambient Blobs -->
    <div class="blob w-96 h-96 rounded-full top-0 left-0 mix-blend-multiply" style="background-color: var(--primary-color); opacity: 0.3;"></div>
    <div class="blob w-96 h-96 rounded-full bottom-0 right-0 mix-blend-multiply animation-delay-2000" style="background-color: var(--secondary-color); opacity: 0.3;"></div>

    <!-- Sidebar -->
    <aside class="w-72 glass-sidebar flex-shrink-0 flex flex-col transition-transform duration-300 transform fixed md:relative z-40 h-full" id="sidebar">
        <div class="p-8 flex items-center gap-4">
            <!-- Dynamic Logo Container -->
            <div id="sidebar-logo-container" class="w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg overflow-hidden bg-white">
                <i class="ph ph-church text-2xl text-slate-400"></i>
            </div>
            
            <div>
                <h1 class="font-bold text-xl tracking-tight text-slate-900" id="church-name-display">FaithFlow</h1>
                <p class="text-xs font-medium text-slate-500 uppercase tracking-wider">Church Manager</p>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 px-6 space-y-2">
            <a href="#" onclick="app.nav('dashboard')" class="sidebar-link active flex items-center gap-4 px-4 py-3 transition-all group">
                <i class="ph ph-squares-four text-2xl"></i>
                <span class="font-medium text-base">Dashboard</span>
            </a>
            <a href="#" onclick="app.nav('members')" class="sidebar-link flex items-center gap-4 px-4 py-3 transition-all group">
                <i class="ph ph-users text-2xl"></i>
                <span class="font-medium text-base">Members</span>
            </a>
            <a href="#" onclick="app.nav('finance')" class="sidebar-link flex items-center gap-4 px-4 py-3 transition-all group">
                <i class="ph ph-currency-dollar text-2xl"></i>
                <span class="font-medium text-base">Finance</span>
            </a>
            <a href="#" onclick="app.nav('worship')" class="sidebar-link flex items-center gap-4 px-4 py-3 transition-all group">
                <i class="ph ph-music-notes text-2xl"></i>
                <span class="font-medium text-base">Worship & Hymns</span>
            </a>
            <a href="#" onclick="app.nav('announcements')" class="sidebar-link flex items-center gap-4 px-4 py-3 transition-all group">
                <i class="ph ph-megaphone text-2xl"></i>
                <span class="font-medium text-base">Announcements</span>
            </a>
            <a href="#" onclick="app.nav('bible')" class="sidebar-link flex items-center gap-4 px-4 py-3 transition-all group">
                <i class="ph ph-book-open-text text-2xl"></i>
                <span class="font-medium text-base">Bible</span>
            </a>
            
            <div class="pt-6 mt-6 border-t border-slate-200/50">
                <p class="px-4 text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Community</p>
                <a href="#" onclick="app.nav('chat')" class="sidebar-link flex items-center gap-4 px-4 py-3 transition-all group">
                    <i class="ph ph-chats-circle text-2xl"></i>
                    <span class="font-medium text-base">Community Chat</span>
                </a>
            </div>

            <div class="pt-2 mt-2">
                <p class="px-4 text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">System</p>
                <a href="#" onclick="app.nav('settings')" class="sidebar-link flex items-center gap-4 px-4 py-3 transition-all group">
                    <i class="ph ph-gear text-2xl"></i>
                    <span class="font-medium text-base">Settings</span>
                </a>
            </div>
        </nav>
        
        <!-- Import Input Hidden -->
        <input type="file" id="import-file" accept=".json" class="hidden" onchange="app.io.handleImport(this)">
    </aside>

    <!-- Overlay for mobile sidebar -->
    <div id="sidebar-overlay" onclick="document.getElementById('sidebar').classList.add('-translate-x-full'); document.getElementById('sidebar-overlay').classList.add('hidden');" class="fixed inset-0 bg-black/20 backdrop-blur-sm z-30 hidden md:hidden"></div>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <!-- Mobile Header -->
        <header class="md:hidden glass-panel border-b-0 m-4 mb-0 rounded-2xl p-4 flex items-center justify-between z-20">
            <button onclick="document.getElementById('sidebar').classList.remove('-translate-x-full'); document.getElementById('sidebar-overlay').classList.remove('hidden');" class="text-slate-600">
                <i class="ph ph-list text-2xl"></i>
            </button>
            <span class="font-bold text-lg text-slate-800">FaithFlow</span>
            <div class="w-8"></div> <!-- Spacer for center alignment -->
        </header>

        <!-- Dynamic View Container -->
        <div id="view-container" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">
            <!-- Content Injected via JS -->
        </div>
    </main>

    <!-- Presentation Mode Overlay -->
    <div id="presentation-layer" onclick="app.worship.exitPresentation()">
        <img id="presentation-logo" src="" alt="Church Logo" class="hidden">
        <div id="presentation-text" class="animate-pulse">Slide Content</div>
        <div class="fixed bottom-10 text-white/40 text-sm font-medium tracking-widest uppercase">Tap to Exit</div>
        <div class="fixed bottom-10 right-10 flex gap-4" onclick="event.stopPropagation()">
            <button onclick="app.worship.prevSlide()" class="w-16 h-16 bg-white/10 backdrop-blur-md rounded-full hover:bg-white/20 flex items-center justify-center transition-all active:scale-95"><i class="ph ph-arrow-left text-2xl"></i></button>
            <button onclick="app.worship.nextSlide()" class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-full hover:bg-white/30 flex items-center justify-center transition-all active:scale-95"><i class="ph ph-arrow-right text-2xl"></i></button>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-backdrop" class="fixed inset-0 bg-slate-900/40 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div id="modal-content" class="glass-panel bg-white/90 rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100 animate-in fade-in zoom-in duration-200">
            <!-- Modal injected here -->
        </div>
    </div>

    <script>
        /** * FAITHFLOW CORE ENGINE v3.0
         * Features: Custom Data Parsers, Auto-Config, Nested Bible Search
         */

        const DB_KEYS = {
            MEMBERS: 'faithflow_members',
            FINANCE: 'faithflow_finance',
            HYMNS: 'faithflow_hymns',
            ANNOUNCEMENTS: 'faithflow_announcements',
            SETTINGS: 'faithflow_settings',
            BIBLE: 'faithflow_bible_data',
            FIREBASE_CONFIG: 'faithflow_firebase_config'
        };

        const Store = {
            get(key, defaultVal = []) {
                try {
                    const data = localStorage.getItem(key);
                    const parsed = data ? JSON.parse(data) : null;
                    return parsed !== null ? parsed : defaultVal;
                } catch(e) { return defaultVal; }
            },
            set(key, data) {
                localStorage.setItem(key, JSON.stringify(data));
                return data;
            },
            async init() {
                // 1. Load Config from file first
                await this.loadConfig();

                // 2. Initialize defaults if config didn't set them
                if (!localStorage.getItem(DB_KEYS.SETTINGS)) {
                    this.set(DB_KEYS.SETTINGS, {
                        churchName: "Grace Chapel",
                        currency: "$",
                        primaryColor: "#3b82f6",
                        secondaryColor: "#8b5cf6"
                    });
                }

                // 3. Auto-load Content files
                // Using merge=true for lists (hymns, announcements, members) to add new items
                // Using merge=false for Bible to replace with the full book structure
                await this.loadExternalData('data/bible.json', DB_KEYS.BIBLE, false);
                await this.loadExternalData('data/hymns.json', DB_KEYS.HYMNS, true);
                await this.loadExternalData('data/announcements.json', DB_KEYS.ANNOUNCEMENTS, true);
                await this.loadExternalData('data/members.json', DB_KEYS.MEMBERS, true);
            },

            async loadConfig() {
                try {
                    const response = await fetch('data/config.json');
                    if (response.ok) {
                        const config = await response.json();
                        const currentSettings = this.get(DB_KEYS.SETTINGS) || {};
                        
                        // Map config.json structure to internal settings
                        const newSettings = {
                            ...currentSettings,
                            churchName: config.defaultChurchName || currentSettings.churchName,
                            primaryColor: config.defaultTheme?.primaryColor || currentSettings.primaryColor,
                            secondaryColor: config.defaultTheme?.secondaryColor || currentSettings.secondaryColor,
                            accentColor: config.defaultTheme?.accentColor || currentSettings.accentColor,
                            // Store other config parts if needed
                            financeCategories: config.financeCategories
                        };
                        this.set(DB_KEYS.SETTINGS, newSettings);
                        console.log("Config loaded successfully");
                    }
                } catch (e) { console.log("No external config found, using defaults."); }
            },

            async loadExternalData(path, key, merge = false) {
                try {
                    const response = await fetch(path);
                    if (response.ok) {
                        const data = await response.json();
                        if (merge && Array.isArray(data)) {
                            const current = Utils.safeArray(this.get(key));
                            // Deduplicate by ID or Title
                            const newItems = data.filter(i => !current.find(c => (c.id && c.id === i.id) || (c.title && c.title === i.title)));
                            this.set(key, [...current, ...newItems]);
                        } else {
                            // For objects like Bible or if replacing
                            this.set(key, data);
                        }
                        console.log(`Loaded ${path}`);
                    }
                } catch (e) { console.log(`Auto-load skipped: ${path}`); }
            }
        };

        const Utils = {
            id: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
            formatMoney: (amount) => {
                const settings = Store.get(DB_KEYS.SETTINGS);
                return `${settings.currency || '$'}${parseFloat(amount).toFixed(2)}`;
            },
            formatDate: (dateStr) => {
                if(!dateStr) return '';
                return new Date(dateStr).toLocaleDateString(undefined, { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
            },
            safeArray: (data) => Array.isArray(data) ? data : [] 
        };

        const app = {
            state: {
                currentView: 'dashboard',
                presentationContent: null,
                currentSlideIndex: 0,
                db: null,
                chatUnsubscribe: null
            },

            async init() {
                await Store.init();
                this.applySettings();
                this.nav('dashboard');
                if(window.innerWidth < 768) {
                    document.getElementById('sidebar').classList.add('-translate-x-full');
                }
            },

            applySettings() {
                const settings = Store.get(DB_KEYS.SETTINGS);
                document.getElementById('church-name-display').innerText = settings.churchName;
                const root = document.documentElement;
                root.style.setProperty('--primary-color', settings.primaryColor || '#3b82f6');
                root.style.setProperty('--secondary-color', settings.secondaryColor || '#8b5cf6');
                root.style.setProperty('--bg-start', settings.primaryColor + '20');
                root.style.setProperty('--bg-end', settings.secondaryColor + '20');
                
                const logoContainer = document.getElementById('sidebar-logo-container');
                if (settings.churchLogo) {
                    logoContainer.innerHTML = `<img src="${settings.churchLogo}" class="w-full h-full object-cover">`;
                } else {
                    logoContainer.innerHTML = `<i class="ph ph-church text-2xl text-slate-400"></i>`;
                }
            },

            nav(viewName) {
                this.state.currentView = viewName;
                if(this.state.chatUnsubscribe && viewName !== 'chat') {
                    this.state.chatUnsubscribe();
                    this.state.chatUnsubscribe = null;
                }
                
                document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
                const activeLink = document.querySelector(`.sidebar-link[onclick="app.nav('${viewName}')"]`);
                if(activeLink) activeLink.classList.add('active');

                const container = document.getElementById('view-container');
                container.style.opacity = '0';
                
                setTimeout(() => {
                    try {
                        container.innerHTML = this.views[viewName]();
                        if (this.controllers[viewName]) this.controllers[viewName]();
                    } catch(e) {
                        console.error("View Error:", e);
                        container.innerHTML = `<div class="p-8 text-center text-red-500">Error loading view. Data may be corrupted. <br> <button onclick="localStorage.clear(); window.location.reload()" class="mt-4 px-4 py-2 bg-red-100 rounded">Reset App Data</button></div>`;
                    }
                    container.style.opacity = '1';
                    container.style.transition = 'opacity 0.2s ease';
                }, 100);

                if(window.innerWidth < 768) {
                    document.getElementById('sidebar').classList.add('-translate-x-full');
                    document.getElementById('sidebar-overlay').classList.add('hidden');
                }
            },

            // --- IO & SHARING ---
            io: {
                triggerImport() { document.getElementById('import-file').click(); },
                
                handleImport(input) {
                    const file = input.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (confirm(`Import data from "${data.source || 'File'}"?`)) {
                                this.mergeData(data);
                                alert('Data imported successfully!');
                                window.location.reload();
                            }
                        } catch (err) { alert('Invalid file format.'); }
                    };
                    reader.readAsText(file);
                    input.value = ''; 
                },

                mergeData(data) {
                    // Smart merging based on known arrays vs objects
                    if (data.hymns && Array.isArray(data.hymns)) {
                        const current = Utils.safeArray(Store.get(DB_KEYS.HYMNS));
                        const newItems = data.hymns.filter(n => !current.find(c => c.title === n.title));
                        Store.set(DB_KEYS.HYMNS, [...current, ...newItems]);
                    }
                    if (data.announcements && Array.isArray(data.announcements)) {
                        const current = Utils.safeArray(Store.get(DB_KEYS.ANNOUNCEMENTS));
                        Store.set(DB_KEYS.ANNOUNCEMENTS, [...current, ...data.announcements]);
                    }
                    if (data.members && Array.isArray(data.members)) {
                        const current = Utils.safeArray(Store.get(DB_KEYS.MEMBERS));
                        Store.set(DB_KEYS.MEMBERS, [...current, ...data.members]);
                    }
                    if (data.bible) {
                        Store.set(DB_KEYS.BIBLE, data.bible);
                    }
                },

                exportPackage(type) {
                    const settings = Store.get(DB_KEYS.SETTINGS);
                    let data = { 
                        source: settings.churchName, 
                        timestamp: new Date().toISOString(),
                        version: "3.0" 
                    };
                    if (type === 'full') {
                        data.members = Store.get(DB_KEYS.MEMBERS);
                        data.finance = Store.get(DB_KEYS.FINANCE);
                        data.hymns = Store.get(DB_KEYS.HYMNS);
                        data.announcements = Store.get(DB_KEYS.ANNOUNCEMENTS);
                        data.bible = Store.get(DB_KEYS.BIBLE);
                    } else if (type === 'public') {
                        data.hymns = Store.get(DB_KEYS.HYMNS);
                        data.announcements = Store.get(DB_KEYS.ANNOUNCEMENTS);
                        data.bible = Store.get(DB_KEYS.BIBLE);
                    }
                    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `FaithFlow_${type}_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                }
            },

            // --- VIEWS ---
            views: {
                dashboard: () => {
                    const members = Utils.safeArray(Store.get(DB_KEYS.MEMBERS));
                    const hymns = Utils.safeArray(Store.get(DB_KEYS.HYMNS));
                    const finance = Utils.safeArray(Store.get(DB_KEYS.FINANCE));
                    const totalFinance = finance.reduce((acc, curr) => acc + (parseFloat(curr.amount) || 0), 0);
                    const announcements = Utils.safeArray(Store.get(DB_KEYS.ANNOUNCEMENTS)).slice(0, 3);
                    const settings = Store.get(DB_KEYS.SETTINGS);

                    return `
                        <div class="mb-8">
                            <h2 class="text-3xl font-bold text-slate-800 tracking-tight">Dashboard</h2>
                            <p class="text-slate-500 font-medium">Overview for ${settings.churchName}</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="glass-card p-6 flex flex-col justify-between h-32 relative overflow-hidden group">
                                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                    <i class="ph ph-users text-8xl text-theme-primary"></i>
                                </div>
                                <p class="text-sm font-bold text-slate-500 uppercase tracking-wider">Members</p>
                                <h3 class="text-4xl font-bold text-slate-800">${members.length}</h3>
                            </div>
                            <div class="glass-card p-6 flex flex-col justify-between h-32 relative overflow-hidden group">
                                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                    <i class="ph ph-currency-dollar text-8xl text-green-600"></i>
                                </div>
                                <p class="text-sm font-bold text-slate-500 uppercase tracking-wider">Total Funds</p>
                                <h3 class="text-4xl font-bold text-slate-800">${Utils.formatMoney(totalFinance)}</h3>
                            </div>
                            <div class="glass-card p-6 flex flex-col justify-between h-32 relative overflow-hidden group">
                                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                    <i class="ph ph-music-notes text-8xl text-purple-600"></i>
                                </div>
                                <p class="text-sm font-bold text-slate-500 uppercase tracking-wider">Worship Songs</p>
                                <h3 class="text-4xl font-bold text-slate-800">${hymns.length}</h3>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <!-- Announcements Feed -->
                            <div class="lg:col-span-2 glass-card p-8">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="font-bold text-xl text-slate-800">Bulletin Board</h3>
                                    <button onclick="app.nav('announcements')" class="text-sm font-semibold text-theme-primary hover:underline">View All</button>
                                </div>
                                <div class="space-y-4">
                                    ${announcements.length ? announcements.map(a => `
                                        <div class="flex gap-4 items-start p-4 rounded-2xl bg-white/40 hover:bg-white/60 transition-colors border border-white/50">
                                            <div class="w-12 h-12 rounded-xl bg-orange-100/50 flex-shrink-0 flex items-center justify-center text-orange-600 shadow-sm">
                                                <i class="ph ph-megaphone text-xl"></i>
                                            </div>
                                            <div>
                                                <h4 class="font-bold text-slate-800 text-lg">${a.title}</h4>
                                                <p class="text-slate-600 leading-relaxed">${a.message}</p>
                                                <p class="text-xs font-bold text-slate-400 mt-2 uppercase tracking-wide">${Utils.formatDate(a.date)}</p>
                                            </div>
                                        </div>
                                    `).join('') : '<p class="text-slate-400 italic text-center py-4">No active announcements.</p>'}
                                </div>
                            </div>

                            <!-- Quick Actions -->
                            <div class="glass-card p-8">
                                <h3 class="font-bold text-xl text-slate-800 mb-6">Quick Actions</h3>
                                <div class="grid grid-cols-1 gap-3">
                                    <button onclick="app.modals.addMember()" class="flex items-center gap-3 p-4 rounded-xl bg-white/50 hover:bg-white/80 text-slate-700 transition-all font-medium border border-white/40">
                                        <i class="ph ph-user-plus text-xl text-theme-primary"></i> Add Member
                                    </button>
                                    <button onclick="app.modals.addFinance()" class="flex items-center gap-3 p-4 rounded-xl bg-white/50 hover:bg-white/80 text-slate-700 transition-all font-medium border border-white/40">
                                        <i class="ph ph-coins text-xl text-green-600"></i> Record Offering
                                    </button>
                                    <button onclick="app.nav('worship')" class="flex items-center gap-3 p-4 rounded-xl bg-white/50 hover:bg-white/80 text-slate-700 transition-all font-medium border border-white/40">
                                        <i class="ph ph-projector-screen text-xl text-purple-600"></i> Worship Mode
                                    </button>
                                    <div class="h-px bg-slate-200 my-2"></div>
                                    <button onclick="app.io.triggerImport()" class="flex items-center gap-3 p-4 rounded-xl bg-white/50 hover:bg-white/80 text-slate-700 transition-all font-medium border border-white/40">
                                        <i class="ph ph-download-simple text-xl text-slate-500"></i> Import Update
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                },

                members: () => {
                    const members = Utils.safeArray(Store.get(DB_KEYS.MEMBERS));
                    return `
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="text-3xl font-bold text-slate-800">Members</h2>
                            <button onclick="app.modals.addMember()" class="bg-theme-primary hover:bg-opacity-90 text-white px-5 py-2.5 rounded-xl shadow-lg flex items-center gap-2 font-medium transition-all transform active:scale-95">
                                <i class="ph ph-plus-circle text-lg"></i> Add New
                            </button>
                        </div>
                        <div class="glass-card overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left border-collapse">
                                    <thead class="bg-slate-50/50 text-slate-500 text-xs uppercase font-bold tracking-wider border-b border-slate-200">
                                        <tr>
                                            <th class="px-8 py-5">Name</th>
                                            <th class="px-8 py-5">Phone</th>
                                            <th class="px-8 py-5">Role/Dept</th>
                                            <th class="px-8 py-5 text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">
                                        ${members.length ? members.map(m => `
                                            <tr class="hover:bg-blue-50/30 transition-colors">
                                                <td class="px-8 py-5 font-semibold text-slate-700">${m.fullName || m.name}</td>
                                                <td class="px-8 py-5 text-slate-500 font-mono text-sm">${m.phone || '-'}</td>
                                                <td class="px-8 py-5">
                                                    <span class="px-3 py-1 bg-white/60 border border-slate-200 text-slate-700 rounded-full text-xs font-bold uppercase">${m.department || m.role || 'Member'}</span>
                                                </td>
                                                <td class="px-8 py-5 text-right">
                                                    <button onclick="app.deleteItem('${DB_KEYS.MEMBERS}', '${m.id}', 'members')" class="text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-lg transition-colors"><i class="ph ph-trash text-lg"></i></button>
                                                </td>
                                            </tr>
                                        `).join('') : `<tr><td colspan="4" class="px-8 py-12 text-center text-slate-400">No members found.</td></tr>`}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                },

                finance: () => {
                    const records = Utils.safeArray(Store.get(DB_KEYS.FINANCE));
                    return `
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="text-3xl font-bold text-slate-800">Finance</h2>
                            <button onclick="app.modals.addFinance()" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-xl shadow-lg shadow-green-500/30 flex items-center gap-2 font-medium transition-all transform active:scale-95">
                                <i class="ph ph-plus-circle text-lg"></i> Record
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                             <div class="glass-card p-8">
                                <h3 class="font-bold text-lg text-slate-700 mb-6">Financial Overview</h3>
                                <div class="h-64 flex items-center justify-center">
                                    <canvas id="financeChart"></canvas>
                                </div>
                             </div>
                             <div class="glass-card p-0 overflow-hidden flex flex-col">
                                <div class="p-6 border-b border-slate-100 bg-slate-50/30">
                                    <h3 class="font-bold text-lg text-slate-700">Recent Transactions</h3>
                                </div>
                                <div class="overflow-y-auto p-6 space-y-3 max-h-96 custom-scroll">
                                    ${records.sort((a,b) => new Date(b.date) - new Date(a.date)).map(r => `
                                        <div class="flex justify-between items-center p-4 rounded-2xl bg-white/60 border border-white shadow-sm">
                                            <div>
                                                <p class="font-bold text-slate-800">${r.category}</p>
                                                <p class="text-xs font-medium text-slate-400 uppercase tracking-wide">${Utils.formatDate(r.date)}</p>
                                            </div>
                                            <span class="font-bold font-mono text-lg ${r.type === 'expense' ? 'text-red-500' : 'text-green-600'}">
                                                ${r.type === 'expense' ? '-' : '+'}${Utils.formatMoney(r.amount)}
                                            </span>
                                        </div>
                                    `).join('') || '<p class="text-slate-400 text-center py-8">No records yet.</p>'}
                                </div>
                             </div>
                        </div>
                    `;
                },

                worship: () => {
                    const hymns = Utils.safeArray(Store.get(DB_KEYS.HYMNS));
                    return `
                        <div class="flex justify-between items-center mb-8">
                            <div>
                                <h2 class="text-3xl font-bold text-slate-800">Worship</h2>
                                <p class="text-slate-500 text-sm">Songs & Hymns</p>
                            </div>
                            <button onclick="app.modals.addHymn()" class="bg-purple-600 hover:bg-purple-700 text-white px-5 py-2.5 rounded-xl shadow-lg shadow-purple-500/30 flex items-center gap-2 font-medium transition-all transform active:scale-95">
                                <i class="ph ph-music-notes-plus text-lg"></i> Add Song
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${hymns.map(h => `
                                <div class="glass-card p-6 hover:shadow-xl hover:border-purple-300/50 transition-all group relative">
                                    <div class="flex justify-between items-start mb-4">
                                        <h3 class="font-bold text-xl text-slate-800 line-clamp-1">${h.title}</h3>
                                        ${h.number ? `<span class="text-xs font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded">${h.number}</span>` : ''}
                                    </div>
                                    <div class="flex justify-between items-center mb-4">
                                        <span class="text-xs text-purple-600 bg-purple-50 px-2 py-1 rounded uppercase tracking-wide">${h.category || 'Song'}</span>
                                        <button onclick="app.deleteItem('${DB_KEYS.HYMNS}', '${h.id}', 'worship')" class="text-slate-300 hover:text-red-500 p-1 transition-colors"><i class="ph ph-trash"></i></button>
                                    </div>
                                    <div class="bg-slate-50/50 rounded-xl p-4 mb-4 border border-slate-100 h-32 overflow-hidden relative">
                                        <p class="text-slate-500 text-sm font-serif italic whitespace-pre-line leading-relaxed">${h.lyrics.substring(0, 150)}...</p>
                                        <div class="absolute inset-0 bg-gradient-to-t from-slate-50 via-transparent to-transparent"></div>
                                    </div>
                                    <button onclick="app.worship.present('${h.id}', 'song')" class="w-full bg-slate-800 hover:bg-purple-600 text-white py-3 rounded-xl font-medium shadow-lg shadow-slate-900/10 flex items-center justify-center gap-2 transition-all">
                                        <i class="ph ph-projector-screen text-lg"></i> Present
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                },

                announcements: () => {
                    const list = Utils.safeArray(Store.get(DB_KEYS.ANNOUNCEMENTS));
                    return `
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="text-3xl font-bold text-slate-800">Announcements</h2>
                            <button onclick="app.modals.addAnnouncement()" class="bg-orange-500 hover:bg-orange-600 text-white px-5 py-2.5 rounded-xl shadow-lg shadow-orange-500/30 flex items-center gap-2 font-medium transition-all transform active:scale-95">
                                <i class="ph ph-plus-circle text-lg"></i> Post New
                            </button>
                        </div>
                        <div class="space-y-6 max-w-4xl mx-auto">
                            ${list.length ? list.map(a => `
                                <div class="glass-card p-8 flex flex-col md:flex-row gap-6 items-start group">
                                    <div class="w-16 h-16 rounded-2xl bg-orange-100 flex-shrink-0 flex items-center justify-center text-orange-600 text-2xl font-bold shadow-inner">
                                        ${new Date(a.date).getDate() || '-'}
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-start">
                                            <h3 class="text-xl font-bold text-slate-800 mb-2">${a.title}</h3>
                                            <button onclick="app.deleteItem('${DB_KEYS.ANNOUNCEMENTS}', '${a.id}', 'announcements')" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i class="ph ph-trash text-xl"></i></button>
                                        </div>
                                        <p class="text-slate-600 leading-relaxed whitespace-pre-wrap">${a.message}</p>
                                        <div class="mt-4 flex gap-2">
                                            <span class="text-xs font-bold text-slate-400 bg-slate-100 px-3 py-1 rounded-full uppercase tracking-wide">Public</span>
                                            <span class="text-xs font-bold text-slate-400 bg-slate-100 px-3 py-1 rounded-full uppercase tracking-wide">${Utils.formatDate(a.date)}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('') : '<div class="text-center py-20 text-slate-400">No announcements posted yet.</div>'}
                        </div>
                    `;
                },

                bible: () => {
                    return `
                        <div class="flex flex-col h-full max-w-4xl mx-auto text-center">
                            <div class="glass-card p-12 flex-1 flex flex-col items-center justify-center relative">
                                <div class="w-24 h-24 bg-blue-50 rounded-full flex items-center justify-center mb-6">
                                    <i class="ph ph-book-open-text text-5xl text-blue-400"></i>
                                </div>
                                <h2 class="text-3xl font-bold text-slate-800 mb-2">Scripture Reader</h2>
                                <p class="text-slate-500 mb-8 max-w-md">Access the word offline. Search by reference (e.g. "John 3:16") or keyword.</p>
                                
                                <div class="w-full max-w-lg relative mb-10">
                                    <input type="text" id="bible-search" placeholder="Search (e.g., 'John 3:16' or 'love')" class="w-full pl-6 pr-32 py-4 rounded-2xl border-none bg-slate-100 focus:bg-white focus:ring-4 focus:ring-blue-200 transition-all text-lg shadow-inner outline-none">
                                    <button onclick="app.bibleSearch()" class="absolute right-2 top-2 bottom-2 bg-theme-primary text-white px-6 rounded-xl font-medium hover:opacity-90 transition-colors">Search</button>
                                </div>

                                <!-- Result Display -->
                                <div id="bible-result" class="hidden text-left bg-blue-50/50 p-8 rounded-2xl border border-blue-100 max-w-2xl w-full relative group">
                                    <div class="flex justify-between items-start mb-4">
                                        <h4 class="font-bold text-blue-900 text-xl border-b border-blue-200 pb-2" id="verse-ref"></h4>
                                        <button onclick="app.worship.present(null, 'bible')" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm font-bold shadow-md opacity-0 group-hover:opacity-100 transition-opacity">
                                            <i class="ph ph-projector-screen mr-1"></i> Present
                                        </button>
                                    </div>
                                    <p class="text-slate-700 text-xl font-serif leading-relaxed" id="verse-text"></p>
                                    <input type="hidden" id="current-verse-data">
                                </div>
                                
                                <div id="bible-error" class="hidden text-slate-400 mt-4 italic"></div>
                                
                                <!-- Quick Suggestions when empty -->
                                <div id="bible-suggestions" class="mt-8 flex gap-3 text-sm text-slate-400">
                                    <span>Try:</span>
                                    <button onclick="document.getElementById('bible-search').value='John 3:16'; app.bibleSearch()" class="hover:text-blue-500 underline">John 3:16</button>
                                    <button onclick="document.getElementById('bible-search').value='Psalm 23:1'; app.bibleSearch()" class="hover:text-blue-500 underline">Psalm 23:1</button>
                                </div>
                            </div>
                        </div>
                    `;
                },

                chat: () => {
                    const firebaseConfig = Store.get(DB_KEYS.FIREBASE_CONFIG);
                    if (!firebaseConfig || !firebaseConfig.projectId) {
                        return `
                            <div class="flex flex-col h-full max-w-2xl mx-auto text-center justify-center">
                                <div class="glass-card p-12">
                                    <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                        <i class="ph ph-cloud-slash text-4xl text-blue-600"></i>
                                    </div>
                                    <h2 class="text-2xl font-bold text-slate-800 mb-2">Setup Community Chat</h2>
                                    <p class="text-slate-500 mb-6">To enable real-time chat, you need to provide a Firebase Configuration in Settings.</p>
                                    <button onclick="app.nav('settings')" class="bg-theme-primary text-white px-6 py-3 rounded-xl font-bold shadow-lg">Go to Settings</button>
                                </div>
                            </div>
                        `;
                    }

                    return `
                        <div class="flex flex-col h-full max-w-4xl mx-auto">
                            <div class="glass-card flex-1 flex flex-col overflow-hidden relative">
                                <div class="p-4 border-b border-white/20 bg-white/40 backdrop-blur-md z-10 flex justify-between items-center">
                                    <div>
                                        <h3 class="font-bold text-slate-800">Community Chat</h3>
                                        <p class="text-xs text-slate-500 flex items-center gap-1"><span class="w-2 h-2 bg-green-500 rounded-full"></span> Online</p>
                                    </div>
                                    <div class="text-xs text-slate-400">Powered by Firebase</div>
                                </div>
                                
                                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/30 scroll-smooth">
                                    <div class="flex justify-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div>
                                </div>

                                <form onsubmit="app.handlers.sendMessage(event)" class="p-4 bg-white/60 border-t border-white/20 flex gap-2">
                                    <input type="text" name="message" id="chat-input" placeholder="Type a message..." class="flex-1 bg-white border-0 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none shadow-inner" autocomplete="off">
                                    <button type="submit" class="bg-theme-primary text-white p-3 rounded-xl hover:opacity-90 transition-colors shadow-lg">
                                        <i class="ph ph-paper-plane-right text-xl"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    `;
                },

                settings: () => {
                    const settings = Store.get(DB_KEYS.SETTINGS);
                    const firebaseConfig = Store.get(DB_KEYS.FIREBASE_CONFIG) || {};
                    return `
                        <div class="max-w-3xl mx-auto pb-10">
                            <h2 class="text-3xl font-bold text-slate-800 mb-8">Settings & Branding</h2>
                            
                            <!-- Branding -->
                            <div class="glass-card p-8 mb-8">
                                <h3 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2"><i class="ph ph-paint-brush text-theme-primary"></i> Church Branding</h3>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <label class="block text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">Church Name</label>
                                        <input type="text" id="set-church-name" value="${settings.churchName}" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">Church Logo</label>
                                        <div class="flex gap-4 items-center">
                                            <div class="w-12 h-12 rounded-xl border border-slate-200 overflow-hidden flex-shrink-0 bg-white">
                                                ${settings.churchLogo ? `<img src="${settings.churchLogo}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-slate-300"><i class="ph ph-image"></i></div>`}
                                            </div>
                                            <label class="flex-1 cursor-pointer bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm text-slate-500 hover:bg-slate-50 text-center">
                                                <span>Upload New Logo</span>
                                                <input type="file" id="set-church-logo" accept="image/*" class="hidden">
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">Primary Color</label>
                                        <div class="flex gap-2">
                                            <input type="color" id="set-primary-color" value="${settings.primaryColor || '#3b82f6'}" class="h-12 w-16 p-1 bg-white border border-slate-200 rounded-xl cursor-pointer">
                                            <div class="flex-1 flex items-center px-4 bg-slate-50 rounded-xl text-slate-500 text-sm">Main buttons, accents</div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">Secondary Color</label>
                                        <div class="flex gap-2">
                                            <input type="color" id="set-secondary-color" value="${settings.secondaryColor || '#8b5cf6'}" class="h-12 w-16 p-1 bg-white border border-slate-200 rounded-xl cursor-pointer">
                                            <div class="flex-1 flex items-center px-4 bg-slate-50 rounded-xl text-slate-500 text-sm">Gradients, highlights</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-6 flex justify-end">
                                    <button onclick="app.saveSettings()" class="bg-theme-primary text-white px-6 py-2.5 rounded-xl font-medium shadow-md hover:opacity-90 transition-all">Save Branding</button>
                                </div>
                            </div>

                            <!-- Online Features (Firebase) -->
                            <div class="glass-card p-8 mb-8">
                                <h3 class="text-xl font-bold text-slate-800 mb-2 flex items-center gap-2"><i class="ph ph-cloud-check text-blue-600"></i> Online Features (Firebase)</h3>
                                <p class="text-slate-500 mb-6 text-sm">Paste your Firebase Project Configuration JSON here to enable real-time chat.</p>
                                
                                <textarea id="set-firebase-config" rows="6" placeholder='{"apiKey": "...", "authDomain": "...", "projectId": "..."}' class="w-full bg-slate-900 text-green-400 font-mono text-xs border border-slate-700 rounded-xl px-4 py-3 outline-none mb-4">${JSON.stringify(firebaseConfig, null, 2)}</textarea>
                                
                                <div class="flex justify-end">
                                    <button onclick="app.saveFirebaseConfig()" class="bg-slate-800 text-white px-6 py-2.5 rounded-xl font-medium shadow-md hover:bg-slate-900 transition-all">Update Config</button>
                                </div>
                            </div>

                            <!-- Data Exchange -->
                            <div class="glass-card p-8">
                                <h3 class="text-xl font-bold text-slate-800 mb-2 flex items-center gap-2"><i class="ph ph-arrows-left-right text-green-600"></i> Offline Data Exchange</h3>
                                <p class="text-slate-500 mb-6 text-sm">Share data packages via WhatsApp, Bluetooth, or Email without internet.</p>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-blue-50/50 p-6 rounded-2xl border border-blue-100">
                                        <h4 class="font-bold text-blue-900 mb-2">Admin Export</h4>
                                        <p class="text-sm text-blue-700/70 mb-4">Create a backup file of all members, finances, and content.</p>
                                        <button onclick="app.io.exportPackage('full')" class="w-full bg-blue-600 text-white py-3 rounded-xl font-medium shadow-lg shadow-blue-500/20 hover:bg-blue-700 transition-all">
                                            <i class="ph ph-file-zip mr-2"></i> Download Full Backup
                                        </button>
                                    </div>
                                    <div class="bg-green-50/50 p-6 rounded-2xl border border-green-100">
                                        <h4 class="font-bold text-green-900 mb-2">Public Share</h4>
                                        <p class="text-sm text-green-700/70 mb-4">Create a package of just Hymns & Announcements for members.</p>
                                        <button onclick="app.io.exportPackage('public')" class="w-full bg-green-600 text-white py-3 rounded-xl font-medium shadow-lg shadow-green-500/20 hover:bg-green-700 transition-all">
                                            <i class="ph ph-share-network mr-2"></i> Share Updates
                                        </button>
                                    </div>
                                </div>

                                <div class="mt-8 pt-8 border-t border-slate-100">
                                    <h4 class="font-bold text-slate-700 mb-4">Import Data</h4>
                                    <button onclick="app.io.triggerImport()" class="w-full py-4 border-2 border-dashed border-slate-300 rounded-2xl text-slate-500 font-medium hover:border-blue-500 hover:text-blue-500 hover:bg-blue-50 transition-all flex flex-col items-center justify-center gap-2">
                                        <i class="ph ph-upload-simple text-3xl"></i>
                                        Tap to select a .json file received from Admin
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            },

            // --- CONTROLLERS ---
            controllers: {
                finance: () => {
                    const ctx = document.getElementById('financeChart').getContext('2d');
                    const records = Utils.safeArray(Store.get(DB_KEYS.FINANCE));
                    const income = records.filter(r => r.type === 'income').reduce((a, b) => a + (parseFloat(b.amount) || 0), 0);
                    const expense = records.filter(r => r.type === 'expense').reduce((a, b) => a + (parseFloat(b.amount) || 0), 0);
                    
                    if (income === 0 && expense === 0) {
                        ctx.font = "14px Inter";
                        ctx.fillText("No data yet", 10, 50);
                        return;
                    }

                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Income', 'Expense'],
                            datasets: [{
                                data: [income, expense],
                                backgroundColor: ['#10b981', '#ef4444'],
                                borderWidth: 0,
                                hoverOffset: 10
                            }]
                        },
                        options: { 
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } },
                            cutout: '70%'
                        }
                    });
                },

                chat: () => {
                    const firebaseConfig = Store.get(DB_KEYS.FIREBASE_CONFIG);
                    if (!firebaseConfig || !firebaseConfig.projectId) return;

                    if (!firebase.apps.length) {
                        try { firebase.initializeApp(firebaseConfig); } 
                        catch(e) { 
                            document.getElementById('chat-messages').innerHTML = `<div class="text-center text-red-500 mt-4">Error: ${e.message}</div>`;
                            return;
                        }
                    }
                    
                    app.state.db = firebase.firestore();
                    const messagesContainer = document.getElementById('chat-messages');

                    app.state.chatUnsubscribe = app.state.db.collection('messages')
                        .orderBy('timestamp', 'asc')
                        .limit(50)
                        .onSnapshot((snapshot) => {
                            messagesContainer.innerHTML = '';
                            if(snapshot.empty) {
                                messagesContainer.innerHTML = '<div class="text-center text-slate-400 mt-10">No messages yet.</div>';
                                return;
                            }
                            let myId = localStorage.getItem('faithflow_user_id');
                            if(!myId) { myId = Utils.id(); localStorage.setItem('faithflow_user_id', myId); }

                            snapshot.forEach((doc) => {
                                const msg = doc.data();
                                const isMe = msg.userId === myId;
                                const div = document.createElement('div');
                                div.className = `flex w-full mb-4`;
                                div.innerHTML = `
                                    <div class="chat-bubble ${isMe ? 'chat-own' : 'chat-other'} shadow-sm">
                                        <div class="text-[10px] opacity-70 mb-1 font-bold uppercase tracking-wider">${msg.userName || 'Anonymous'}</div>
                                        <div class="text-sm leading-relaxed">${msg.text}</div>
                                    </div>
                                `;
                                messagesContainer.appendChild(div);
                            });
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }, (error) => {});
                }
            },

            // --- MODALS ---
            modals: {
                open(title, contentHTML) {
                    const backdrop = document.getElementById('modal-backdrop');
                    const container = document.getElementById('modal-content');
                    container.innerHTML = `
                        <div class="px-8 py-6 border-b border-slate-100 flex justify-between items-center bg-white/50">
                            <h3 class="font-bold text-xl text-slate-800">${title}</h3>
                            <button onclick="document.getElementById('modal-backdrop').classList.add('hidden')" class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-500 transition-colors"><i class="ph ph-x text-lg"></i></button>
                        </div>
                        <div class="p-8">
                            ${contentHTML}
                        </div>
                    `;
                    backdrop.classList.remove('hidden');
                },
                addMember() {
                    this.open('Add New Member', `
                        <form onsubmit="app.handlers.saveMember(event)" class="space-y-5">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Full Name</label>
                                <input type="text" name="name" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Phone</label>
                                <input type="tel" name="phone" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Role</label>
                                <select name="role" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none">
                                    <option value="Member">Member</option>
                                    <option value="Leader">Leader</option>
                                    <option value="Visitor">Visitor</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-theme-primary text-white py-3 rounded-xl font-bold shadow-lg hover:opacity-90 mt-4">Save Member</button>
                        </form>
                    `);
                },
                addFinance() {
                    this.open('Record Transaction', `
                        <form onsubmit="app.handlers.saveFinance(event)" class="space-y-5">
                            <div class="grid grid-cols-2 gap-4">
                                <label class="cursor-pointer">
                                    <input type="radio" name="type" value="income" checked class="peer sr-only">
                                    <div class="p-3 text-center rounded-xl border border-slate-200 peer-checked:bg-green-50 peer-checked:border-green-500 peer-checked:text-green-700 font-bold transition-all">Income</div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="type" value="expense" class="peer sr-only">
                                    <div class="p-3 text-center rounded-xl border border-slate-200 peer-checked:bg-red-50 peer-checked:border-red-500 peer-checked:text-red-700 font-bold transition-all">Expense</div>
                                </label>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Category</label>
                                <input type="text" name="category" placeholder="e.g. Sunday Tithe" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Amount</label>
                                <input type="number" step="0.01" name="amount" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-mono text-lg outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Date</label>
                                <input type="date" name="date" required value="${new Date().toISOString().split('T')[0]}" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none">
                            </div>
                            <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-green-500/30 hover:opacity-90 mt-4">Record Transaction</button>
                        </form>
                    `);
                },
                addHymn() {
                    this.open('Add Song', `
                        <form onsubmit="app.handlers.saveHymn(event)" class="space-y-5">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Title</label>
                                <input type="text" name="title" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Lyrics</label>
                                <textarea name="lyrics" rows="8" placeholder="Paste lyrics here (double space for new slides)..." required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-purple-500/30 hover:opacity-90 mt-4">Add to Library</button>
                        </form>
                    `);
                },
                addAnnouncement() {
                    this.open('New Announcement', `
                        <form onsubmit="app.handlers.saveAnnouncement(event)" class="space-y-5">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Title</label>
                                <input type="text" name="title" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Message</label>
                                <textarea name="message" rows="4" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none"></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Date</label>
                                <input type="date" name="date" required value="${new Date().toISOString().split('T')[0]}" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none">
                            </div>
                            <button type="submit" class="w-full bg-orange-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-orange-500/30 hover:opacity-90 mt-4">Post Announcement</button>
                        </form>
                    `);
                }
            },

            handlers: {
                saveMember(e) {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const members = Utils.safeArray(Store.get(DB_KEYS.MEMBERS));
                    members.push({ id: Utils.id(), name: formData.get('name'), phone: formData.get('phone'), role: formData.get('role') });
                    Store.set(DB_KEYS.MEMBERS, members);
                    document.getElementById('modal-backdrop').classList.add('hidden');
                    app.nav('members');
                },
                saveFinance(e) {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const records = Utils.safeArray(Store.get(DB_KEYS.FINANCE));
                    records.push({ id: Utils.id(), type: formData.get('type'), category: formData.get('category'), amount: formData.get('amount'), date: formData.get('date') });
                    Store.set(DB_KEYS.FINANCE, records);
                    document.getElementById('modal-backdrop').classList.add('hidden');
                    app.nav('finance');
                },
                saveHymn(e) {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const hymns = Utils.safeArray(Store.get(DB_KEYS.HYMNS));
                    hymns.push({ id: Utils.id(), title: formData.get('title'), lyrics: formData.get('lyrics') });
                    Store.set(DB_KEYS.HYMNS, hymns);
                    document.getElementById('modal-backdrop').classList.add('hidden');
                    app.nav('worship');
                },
                saveAnnouncement(e) {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const list = Utils.safeArray(Store.get(DB_KEYS.ANNOUNCEMENTS));
                    list.push({ id: Utils.id(), title: formData.get('title'), message: formData.get('message'), date: formData.get('date') });
                    Store.set(DB_KEYS.ANNOUNCEMENTS, list);
                    document.getElementById('modal-backdrop').classList.add('hidden');
                    app.nav('announcements');
                },
                sendMessage(e) {
                    e.preventDefault();
                    const input = document.getElementById('chat-input');
                    const text = input.value.trim();
                    if(!text) return;
                    let myId = localStorage.getItem('faithflow_user_id');
                    const name = "Member " + myId.substr(0,4);
                    app.state.db.collection('messages').add({
                        text: text, userId: myId, userName: name,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    input.value = '';
                }
            },

            deleteItem(key, id, refreshView) {
                if(confirm('Delete this item? This action cannot be undone.')) {
                    const list = Utils.safeArray(Store.get(key));
                    const filtered = list.filter(i => i.id != id);
                    Store.set(key, filtered);
                    app.nav(refreshView);
                }
            },

            saveSettings() {
                const fileInput = document.getElementById('set-church-logo');
                const saveLogic = (logoBase64) => {
                    const newSettings = {
                        churchName: document.getElementById('set-church-name').value,
                        primaryColor: document.getElementById('set-primary-color').value,
                        secondaryColor: document.getElementById('set-secondary-color').value,
                        currency: Store.get(DB_KEYS.SETTINGS).currency || '$',
                        churchLogo: logoBase64 || Store.get(DB_KEYS.SETTINGS).churchLogo
                    };
                    Store.set(DB_KEYS.SETTINGS, newSettings);
                    app.applySettings();
                    alert('Settings saved!');
                };

                if (fileInput.files.length > 0) {
                    const reader = new FileReader();
                    reader.onload = (e) => saveLogic(e.target.result);
                    reader.readAsDataURL(fileInput.files[0]);
                } else {
                    saveLogic(null);
                }
            },

            saveFirebaseConfig() {
                const configStr = document.getElementById('set-firebase-config').value;
                try {
                    const config = JSON.parse(configStr);
                    Store.set(DB_KEYS.FIREBASE_CONFIG, config);
                    alert('Configuration saved! You can now use Community Chat.');
                    app.nav('chat');
                } catch(e) {
                    alert('Invalid JSON. Please ensure it is correctly formatted.');
                }
            },

            worship: {
                present(id, type = 'song') {
                    let title, slides;

                    if (type === 'song') {
                        const hymns = Utils.safeArray(Store.get(DB_KEYS.HYMNS));
                        const hymn = hymns.find(h => h.id == id);
                        if(!hymn) return;
                        title = hymn.title;
                        slides = [hymn.title, ...hymn.lyrics.split('\n\n')];
                    } else if (type === 'bible') {
                        const dataStr = document.getElementById('current-verse-data').value;
                        if (!dataStr) return;
                        const data = JSON.parse(dataStr);
                        title = data.ref;
                        slides = [data.ref, data.text];
                    }

                    app.state.presentationContent = { title, slides };
                    app.state.currentSlideIndex = 0;
                    
                    const layer = document.getElementById('presentation-layer');
                    layer.style.display = 'flex';
                    
                    const settings = Store.get(DB_KEYS.SETTINGS);
                    const logoImg = document.getElementById('presentation-logo');
                    if (settings.churchLogo) {
                        logoImg.src = settings.churchLogo;
                        logoImg.classList.remove('hidden');
                    } else {
                        logoImg.classList.add('hidden');
                    }

                    this.renderSlide();
                },
                renderSlide() {
                    const text = app.state.presentationContent.slides[app.state.currentSlideIndex];
                    document.getElementById('presentation-text').innerText = text;
                },
                nextSlide() {
                    if(app.state.currentSlideIndex < app.state.presentationContent.slides.length - 1) {
                        app.state.currentSlideIndex++;
                        this.renderSlide();
                    }
                },
                prevSlide() {
                    if(app.state.currentSlideIndex > 0) {
                        app.state.currentSlideIndex--;
                        this.renderSlide();
                    }
                },
                exitPresentation() {
                    document.getElementById('presentation-layer').style.display = 'none';
                }
            },

            bibleSearch() {
                const query = document.getElementById('bible-search').value.trim();
                if(!query) return;
                
                const resDiv = document.getElementById('bible-result');
                const errDiv = document.getElementById('bible-error');
                const title = document.getElementById('verse-ref');
                const text = document.getElementById('verse-text');
                const dataInput = document.getElementById('current-verse-data');
                const suggestDiv = document.getElementById('bible-suggestions');

                resDiv.classList.add('hidden');
                errDiv.classList.add('hidden');
                
                const bibleData = Store.get(DB_KEYS.BIBLE);
                let found = null;

                // Handle Nested Object Structure (Standard Bible JSON)
                if (bibleData && !Array.isArray(bibleData) && Object.keys(bibleData).length > 0) {
                    // 1. Parse Reference (e.g. "John 3:16" or "1 John 1:9")
                    // Regex looks for: [Book Name] [Chapter]:[Verse]
                    const refRegex = /^(\d?\s?[a-zA-Z]+)\s+(\d+)[:\s](\d+)$/; 
                    const match = query.match(refRegex);
                    
                    if (match) {
                        const bookQuery = match[1].trim().toLowerCase();
                        const chapter = match[2];
                        const verse = match[3];

                        // Case-insensitive Book Lookup
                        const bookKey = Object.keys(bibleData).find(k => k.toLowerCase() === bookQuery);
                        
                        if (bookKey && bibleData[bookKey][chapter] && bibleData[bookKey][chapter][verse]) {
                            found = {
                                ref: `${bookKey} ${chapter}:${verse}`,
                                text: bibleData[bookKey][chapter][verse]
                            };
                        }
                    } else {
                        // 2. Keyword Search (Iterate entire Bible)
                        const lowerQuery = query.toLowerCase();
                        // Break loops once found for performance
                        outerLoop:
                        for (const [book, chapters] of Object.entries(bibleData)) {
                            for (const [chapNum, verses] of Object.entries(chapters)) {
                                for (const [verseNum, verseText] of Object.entries(verses)) {
                                    if (String(verseText).toLowerCase().includes(lowerQuery)) {
                                        found = {
                                            ref: `${book} ${chapNum}:${verseNum}`,
                                            text: verseText
                                        };
                                        break outerLoop;
                                    }
                                }
                            }
                        }
                    }
                } 
                // Fallback to Array structure (if user used simple list format)
                else if (Array.isArray(bibleData)) {
                     found = bibleData.find(b => b.ref.toLowerCase().includes(query.toLowerCase()) || b.text.toLowerCase().includes(query.toLowerCase()));
                }

                // Demo Fallback if nothing loaded
                if (!found && (!bibleData || Object.keys(bibleData).length === 0)) {
                    if (query.toLowerCase().includes('john 3:16')) {
                        found = { ref: "John 3:16", text: "For God so loved the world, that he gave his only begotten Son, that whosoever believeth in him should not perish, but have everlasting life." };
                    } else if (query.toLowerCase().includes('psalm 23')) {
                        found = { ref: "Psalm 23", text: "The Lord is my shepherd; I shall not want." };
                    }
                }

                if (found) {
                    title.innerText = found.ref;
                    text.innerText = found.text;
                    dataInput.value = JSON.stringify(found);
                    resDiv.classList.remove('hidden');
                    if(suggestDiv) suggestDiv.classList.add('hidden');
                } else {
                    errDiv.innerText = "Verse not found. Check your spelling or ensure 'data/bible.json' is loaded.";
                    errDiv.classList.remove('hidden');
                }
            }
        };

        window.addEventListener('DOMContentLoaded', () => {
            app.init();
            
            document.addEventListener('keydown', (e) => {
                if(document.getElementById('presentation-layer').style.display === 'flex') {
                    if(e.key === 'ArrowRight' || e.key === ' ') app.worship.nextSlide();
                    if(e.key === 'ArrowLeft') app.worship.prevSlide();
                    if(e.key === 'Escape') app.worship.exitPresentation();
                }
            });
        });
    </script>
</body>
</html>